"use strict";function getQueryParams(a){a=a.split("+").join(" ");for(var b,c={},d=/[?&]?([^=]+)=([^&]*)/g;b=d.exec(a);)c[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return c}angular.module("rotationAppApp",[]);var GLOBAL={};angular.module("rotationAppApp").controller("MainCtrl",["$scope",function(a){a.masterParams=null,a.setMasterParams=function(b){a.masterParams={x:b.x,y:b.y,z:b.z,w:b.w}},a.resetMasterParamsToIdentity=function(){console.log("Resetting to identity!"),a.setMasterParams({w:1,x:0,y:0,z:0})},a.resetMasterParamsToIdentity()}]),angular.module("rotationAppApp").controller("MatrixCtrl",["$scope",function(a){var b=function(b,c){if(b!==c){"debug"in GLOBAL.queryParams&&console.log("updateMatrix");var d=new THREE.Quaternion(b.x,b.y,b.z,b.w),e=new THREE.Matrix4;e.makeRotationFromQuaternion(d),a.matrix={xx:e.elements[0],xy:e.elements[4],xz:e.elements[8],yx:e.elements[1],yy:e.elements[5],yz:e.elements[9],zx:e.elements[2],zy:e.elements[6],zz:e.elements[10]}}};a.setMasterParams=function(){console.log("setMasterParams from matrix");var c=a.matrix,d=new THREE.Matrix4;d.set(c.xx,c.xy,c.xz,0,c.yx,c.yy,c.yz,0,c.zx,c.zy,c.zz,0,0,0,0,1);var e=new THREE.Quaternion;e.setFromRotationMatrix(d),e.normalize(),b(e),a.stopWatching(),a.$parent.$parent.setMasterParams({w:e.w,x:e.x,y:e.y,z:e.z}),a.startWatching()},a.startWatching=function(){a.stopWatching=a.$watch("masterParams",b,!0)},b(a.$parent.$parent.masterParams),a.startWatching()}]),angular.module("rotationAppApp").controller("QuaternionCtrl",["$scope","$timeout",function(a,b){var c=function(b,c){b!==c&&("debug"in GLOBAL.queryParams&&console.log("updateQuaternion"),a.quaternion={w:b.w,x:b.x,y:b.y,z:b.z})};a.setMasterParams=function(){console.log("setMasterParams from quaternion");var b=a.quaternion,d=new THREE.Quaternion(b.x,b.y,b.z,b.w);d.normalize(),c(d),a.stopWatching(),a.$parent.$parent.setMasterParams({w:d.w,x:d.x,y:d.y,z:d.z}),a.startWatching()},a.startWatching=function(){a.stopWatching=a.$watch("masterParams",c,!0)},c(a.$parent.$parent.masterParams),a.startWatching()}]),angular.module("rotationAppApp").controller("AngleAxisCtrl",["$scope",function(a){var b=function(b,c){if(b!==c){"debug"in GLOBAL.queryParams&&console.log("updateAngleAxis");var d=new THREE.Quaternion(b.x,b.y,b.z,b.w),e=new THREE.Vector4;e.setAxisAngleFromQuaternion(d),a.angle=180*e.w/Math.PI,a.axis={x:e.x,y:e.y,z:e.z}}};a.setMasterParams=function(){console.log("setMasterParams from angle-axis");var c=a.angle*Math.PI/180,d=a.axis,e=new THREE.Vector3(d.x,d.y,d.z);e.normalize();var f=new THREE.Quaternion;f.setFromAxisAngle(e,c),b(f),a.stopWatching(),a.$parent.$parent.setMasterParams({w:f.w,x:f.x,y:f.y,z:f.z}),a.startWatching()},a.startWatching=function(){a.stopWatching=a.$watch("masterParams",b,!0)},b(a.$parent.$parent.masterParams),a.startWatching()}]),angular.module("rotationAppApp").controller("ThreeViewCtrl",["$scope",function(a){var b="ThreeViewCtrl",c="local",d="world";a.canvasWidth=400,a.canvasHeight=400,a.dofillcontainer=!0,a.scale=1,a.materialType="lambert",a.ctrlQuaternion={x:0,y:0,z:0,w:1},a.controlMode=c,a.controlModeLabel="B",a.test=27;var e=0,f=function(c,d){c!==d&&("debug"in GLOBAL.queryParams&&console.log(b+": updateQuaternion"),a.stopWatchingCtrl(),a.ctrlQuaternion={w:c.w,x:c.x,y:c.y,z:c.z},a.startWatchingCtrl())},g=function(){"debug"in GLOBAL.queryParams&&console.log(b+": setMasterParams "+makeStringQuaternion(a.ctrlQuaternion)),++e,a.stopWatchingMaster(),a.$parent.$parent.setMasterParams(a.ctrlQuaternion),a.startWatchingMaster()};a.toggleControlMode=function(){var e=a.controlMode===d?c:d;console.log(b+": toggle control mode, setting to "+e),a.controlModeLabel=e===d?"A":"B",a.controlMode=e},a.startWatchingMaster=function(){a.stopWatchingMaster=a.$watch("masterParams",f,!0)},a.startWatchingCtrl=function(){a.stopWatchingCtrl=a.$watch("ctrlQuaternion",g,!0)},a.startWatchingMaster(),a.startWatchingCtrl()}]),angular.module("rotationAppApp").directive("ngWebgl",function(){return{restrict:"A",scope:{width:"=",height:"=",fillcontainer:"=",scale:"=",materialType:"=",quaternion:"=",test:"=",controlMode:"="},link:function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p="ngWebgl",q=0,r=0,s=a.fillcontainer?b[0].clientWidth:a.width,t=a.height,u=s/2,v=t/2,w={},x=b[0],y=document.createElement("div");x.appendChild(y);var z=!1;a.init=function(){console.log("ngWebgl init!"),g=new THREE.Clock(!0),d=new THREE.PerspectiveCamera(30,s/t,.1,100),d.position.set(5,5,10),d.lookAt(new THREE.Vector3),e=new THREE.Scene;var b=new THREE.Vector3(0,0,-.01);j=createRigidBasis(1.5,.04),j.position.copy(b),e.add(j),k=createRigidBasis(1,.06),k.position.copy(b),e.add(k),n=new THREE.DirectionalLight(16777215),n.position.set(1,1,1),e.add(n),o=new THREE.DirectionalLight(16777215,.5),o.position.set(-1,-1,-1),e.add(o);var c=document.createElement("canvas");c.width=128,c.height=128;var p=c.getContext("2d"),q=p.createRadialGradient(c.width/2,c.height/2,0,c.width/2,c.height/2,c.width/2);q.addColorStop(.1,"rgba(200,200,200,1)"),q.addColorStop(1,"rgba(255,255,255,1)"),p.fillStyle=q,p.fillRect(0,0,c.width,c.height);var r=new THREE.Texture(c);r.needsUpdate=!0;var u=new THREE.MeshBasicMaterial({map:r}),v=new THREE.PlaneGeometry(3,3,1,1);l=new THREE.Mesh(v,u),l.position.y=-1.5,l.rotation.x=-Math.PI/2,e.add(l);for(var x,z,A,B,C,D=["a","b","c","d"],E=1,F=new THREE.IcosahedronGeometry(E,1),G=0;G<F.faces.length;G++){z=F.faces[G],B=z instanceof THREE.Face3?3:4;for(var H=0;B>H;H++)C=z[D[H]],A=F.vertices[C],x=new THREE.Color(16777215),x.setHSL(.125*C/F.vertices.length,1,.5),z.vertexColors[H]=x}w.lambert=new THREE.MeshLambertMaterial({color:16777215,shading:THREE.FlatShading,vertexColors:THREE.VertexColors}),w.phong=new THREE.MeshPhongMaterial({ambient:197379,color:14540253,specular:39168,shininess:30,shading:THREE.FlatShading,vertexColors:THREE.VertexColors}),w.wireframe=new THREE.MeshBasicMaterial({color:0,shading:THREE.FlatShading,wireframe:!0,transparent:!0}),m=new THREE.Mesh(F,w[a.materialType]),m.position.x=0,m.rotation.x=0,f=new THREE.WebGLRenderer({antialias:!0}),f.setClearColor(16777215),f.setSize(s,t),y.appendChild(f.domElement),e.add(new THREE.GridHelper(5,1)),i=new THREE.TransformControls(d,f.domElement),i.attach(k),i.setMode("rotate"),e.add(i),h=new THREE.OrbitControls(d,y),h.noZoom=!0,h.noPan=!0,f.domElement.addEventListener("mousedown",a.onCanvasMouseDown,!1),f.domElement.addEventListener("mouseup",a.onCanvasMouseUp,!1),document.addEventListener("mousemove",a.onDocumentMouseMove,!1),window.addEventListener("resize",a.onWindowResize,!1),console.log("ngWebgl done initializing!")},a.onWindowResize=function(){a.resizeCanvas()},a.onDocumentMouseMove=function(a){q=a.clientX-u,r=a.clientY-v},a.onCanvasMouseDown=function(a){z=!0},a.onCanvasMouseUp=function(a){z=!1},a.resizeCanvas=function(){s=a.fillcontainer?b[0].clientWidth:a.width,t=a.height,u=s/2,v=t/2,d.aspect=s/t,d.updateProjectionMatrix(),f.setSize(s,t)},a.resizeObject=function(){m.scale.set(a.scale,a.scale,a.scale),l.scale.set(a.scale,a.scale,a.scale)},a.changeMaterial=function(){m.material=w[a.materialType]},a.updateQuaternion=function(){var b=a.quaternion,c=new THREE.Quaternion(b.x,b.y,b.z,b.w);"debug"in GLOBAL.queryParams&&console.log(p+": Received new quaternion: "+makeStringQuaternion(c)),k.setRotationFromQuaternion(b)},a.updateControlMode=function(){i.setSpace("world"===a.controlMode?"world":"local")},a.animate=function(){if(requestAnimationFrame(a.animate),h instanceof THREE.Object3D&&h.update(),i instanceof THREE.Object3D&&i.update(),z){var b=k.quaternion;a.quaternion={x:b.x,y:b.y,z:b.z,w:b.w},a.test=g.getElapsedTime(),a.$apply()}a.render()},a.render=function(){f.render(e,d)},a.$watch("fillcontainer + width + height",function(){a.resizeCanvas()}),a.$watch("scale",function(){a.resizeObject()}),a.$watch("materialType",function(){a.changeMaterial()}),a.$watch("quaternion",function(){a.updateQuaternion()}),a.$watch("controlMode",function(){a.updateControlMode()}),a.init(),a.animate()}}});var createRigidBasis=function(a,b){a=a||1,b=b||.08;var c=new THREE.Object3D;c.scale.set(a,a,a);var d,e,f=b/a,g=new THREE.CylinderGeometry(f,f,.8,12,2),h=new THREE.CylinderGeometry(0,1.5*f,.2,12,2),i=new THREE.MeshLambertMaterial({color:16711680}),j=new THREE.MeshLambertMaterial({color:65280}),k=new THREE.MeshLambertMaterial({color:255}),l=.4,m=.9;return d=new THREE.Mesh(g,i),d.position.x=l,d.rotation.z=-Math.PI/2,d.castShadow=d.receiveShadow=!0,c.add(d),e=new THREE.Mesh(h,i),e.position.x=m,e.rotation.z=-Math.PI/2,e.castShadow=e.receiveShadow=!0,c.add(e),d=new THREE.Mesh(g,j),d.position.y=l,d.castShadow=d.receiveShadow=!0,c.add(d),e=new THREE.Mesh(h,j),e.position.y=m,e.castShadow=e.receiveShadow=!0,c.add(e),d=new THREE.Mesh(g,k),d.position.z=l,d.rotation.x=Math.PI/2,d.castShadow=d.receiveShadow=!0,c.add(d),e=new THREE.Mesh(h,k),e.position.z=m,e.rotation.x=Math.PI/2,e.castShadow=e.receiveShadow=!0,c.add(e),c},makeStringQuaternion=function(a){return"{x: "+a.x+", y: "+a.y+", z: "+a.z+", w: "+a.w+"}"};GLOBAL.queryParams=getQueryParams(document.location.search),THREE.OrbitControls=function(a,b){function c(){return 2*Math.PI/60/60*o.autoRotateSpeed}function d(){return Math.pow(.95,o.zoomSpeed)}function e(a){if(o.enabled!==!1){if(a.preventDefault(),a.button===o.mouseButtons.ORBIT){if(o.noRotate===!0)return;I=H.ROTATE,q.set(a.clientX,a.clientY)}else if(a.button===o.mouseButtons.ZOOM){if(o.noZoom===!0)return;I=H.DOLLY,y.set(a.clientX,a.clientY)}else if(a.button===o.mouseButtons.PAN){if(o.noPan===!0)return;I=H.PAN,t.set(a.clientX,a.clientY)}I!==H.NONE&&(o.domElement.addEventListener("mousemove",f,!1),o.domElement.addEventListener("mouseup",g,!1),o.dispatchEvent(M))}}function f(a){if(o.enabled!==!1){a.preventDefault();var b=o.domElement===document?o.domElement.body:o.domElement;if(I===H.ROTATE){if(o.noRotate===!0)return;r.set(a.clientX,a.clientY),s.subVectors(r,q),o.rotateLeft(2*Math.PI*s.x/b.clientWidth*o.rotateSpeed),o.rotateUp(2*Math.PI*s.y/b.clientHeight*o.rotateSpeed),q.copy(r)}else if(I===H.DOLLY){if(o.noZoom===!0)return;z.set(a.clientX,a.clientY),A.subVectors(z,y),A.y>0?o.dollyIn():A.y<0&&o.dollyOut(),y.copy(z)}else if(I===H.PAN){if(o.noPan===!0)return;u.set(a.clientX,a.clientY),v.subVectors(u,t),o.pan(v.x,v.y),t.copy(u)}I!==H.NONE&&o.update()}}function g(){o.enabled!==!1&&(o.domElement.removeEventListener("mousemove",f,!1),o.domElement.removeEventListener("mouseup",g,!1),o.dispatchEvent(N),I=H.NONE)}function h(a){if(o.enabled!==!1&&o.noZoom!==!0&&I===H.NONE){a.preventDefault(),a.stopPropagation();var b=0;void 0!==a.wheelDelta?b=a.wheelDelta:void 0!==a.detail&&(b=-a.detail),b>0?o.dollyOut():0>b&&o.dollyIn(),o.update(),o.dispatchEvent(M),o.dispatchEvent(N)}}function i(a){if(o.enabled!==!1&&o.noKeys!==!0&&o.noPan!==!0)switch(a.keyCode){case o.keys.UP:o.pan(0,o.keyPanSpeed),o.update();break;case o.keys.BOTTOM:o.pan(0,-o.keyPanSpeed),o.update();break;case o.keys.LEFT:o.pan(o.keyPanSpeed,0),o.update();break;case o.keys.RIGHT:o.pan(-o.keyPanSpeed,0),o.update()}}function j(a){if(o.enabled!==!1){switch(a.touches.length){case 1:if(o.noRotate===!0)return;I=H.TOUCH_ROTATE,q.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(o.noZoom===!0)return;I=H.TOUCH_DOLLY;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY,d=Math.sqrt(b*b+c*c);y.set(0,d);break;case 3:if(o.noPan===!0)return;I=H.TOUCH_PAN,t.set(a.touches[0].pageX,a.touches[0].pageY);break;default:I=H.NONE}I!==H.NONE&&o.dispatchEvent(M)}}function k(a){if(o.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=o.domElement===document?o.domElement.body:o.domElement;switch(a.touches.length){case 1:if(o.noRotate===!0)return;if(I!==H.TOUCH_ROTATE)return;r.set(a.touches[0].pageX,a.touches[0].pageY),s.subVectors(r,q),o.rotateLeft(2*Math.PI*s.x/b.clientWidth*o.rotateSpeed),o.rotateUp(2*Math.PI*s.y/b.clientHeight*o.rotateSpeed),q.copy(r),o.update();break;case 2:if(o.noZoom===!0)return;if(I!==H.TOUCH_DOLLY)return;var c=a.touches[0].pageX-a.touches[1].pageX,d=a.touches[0].pageY-a.touches[1].pageY,e=Math.sqrt(c*c+d*d);z.set(0,e),A.subVectors(z,y),A.y>0?o.dollyOut():A.y<0&&o.dollyIn(),y.copy(z),o.update();break;case 3:if(o.noPan===!0)return;if(I!==H.TOUCH_PAN)return;u.set(a.touches[0].pageX,a.touches[0].pageY),v.subVectors(u,t),o.pan(v.x,v.y),t.copy(u),o.update();break;default:I=H.NONE}}}function l(){o.enabled!==!1&&(o.dispatchEvent(N),I=H.NONE)}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var m,n,o=this,p=1e-6,q=new THREE.Vector2,r=new THREE.Vector2,s=new THREE.Vector2,t=new THREE.Vector2,u=new THREE.Vector2,v=new THREE.Vector2,w=new THREE.Vector3,x=new THREE.Vector3,y=new THREE.Vector2,z=new THREE.Vector2,A=new THREE.Vector2,B=0,C=0,D=1,E=new THREE.Vector3,F=new THREE.Vector3,G=new THREE.Quaternion,H={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},I=H.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom;var J=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),K=J.clone().inverse(),L={type:"change"},M={type:"start"},N={type:"end"};this.rotateLeft=function(a){void 0===a&&(a=c()),C-=a},this.rotateUp=function(a){void 0===a&&(a=c()),B-=a},this.panLeft=function(a){var b=this.object.matrix.elements;w.set(b[0],b[1],b[2]),w.multiplyScalar(-a),E.add(w)},this.panUp=function(a){var b=this.object.matrix.elements;w.set(b[4],b[5],b[6]),w.multiplyScalar(a),E.add(w)},this.pan=function(a,b){var c=o.domElement===document?o.domElement.body:o.domElement;if(o.object instanceof THREE.PerspectiveCamera){var d=o.object.position,e=d.clone().sub(o.target),f=e.length();f*=Math.tan(o.object.fov/2*Math.PI/180),o.panLeft(2*a*f/c.clientHeight),o.panUp(2*b*f/c.clientHeight)}else o.object instanceof THREE.OrthographicCamera?(o.panLeft(a*(o.object.right-o.object.left)/c.clientWidth),o.panUp(b*(o.object.top-o.object.bottom)/c.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(a){void 0===a&&(a=d()),o.object instanceof THREE.PerspectiveCamera?D/=a:o.object instanceof THREE.OrthographicCamera?(o.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*a)),o.object.updateProjectionMatrix(),o.dispatchEvent(L)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(a){void 0===a&&(a=d()),o.object instanceof THREE.PerspectiveCamera?D*=a:o.object instanceof THREE.OrthographicCamera?(o.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/a)),o.object.updateProjectionMatrix(),o.dispatchEvent(L)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(){var a=this.object.position;x.copy(a).sub(this.target),x.applyQuaternion(J),m=Math.atan2(x.x,x.z),n=Math.atan2(Math.sqrt(x.x*x.x+x.z*x.z),x.y),this.autoRotate&&I===H.NONE&&this.rotateLeft(c()),m+=C,n+=B,m=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,m)),n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n)),n=Math.max(p,Math.min(Math.PI-p,n));var b=x.length()*D;b=Math.max(this.minDistance,Math.min(this.maxDistance,b)),this.target.add(E),x.x=b*Math.sin(n)*Math.sin(m),x.y=b*Math.cos(n),x.z=b*Math.sin(n)*Math.cos(m),x.applyQuaternion(K),a.copy(this.target).add(x),this.object.lookAt(this.target),C=0,B=0,D=1,E.set(0,0,0),(F.distanceToSquared(this.object.position)>p||8*(1-G.dot(this.object.quaternion))>p)&&(this.dispatchEvent(L),F.copy(this.object.position),G.copy(this.object.quaternion))},this.reset=function(){I=H.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(L),this.update()},this.getPolarAngle=function(){return n},this.getAzimuthalAngle=function(){return m},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",h,!1),this.domElement.addEventListener("DOMMouseScroll",h,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",l,!1),this.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",i,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,THREE.OrbitControlsLeeper=function(a,b){function c(){return 2*Math.PI/60/60*j.autoRotateSpeed}function d(){return Math.pow(.95,j.userZoomSpeed)}function e(a){j.enabled!==!1&&j.userRotate!==!1&&(a.preventDefault(),0===a.button?(C=B.ROTATE,m.set(a.clientX,a.clientY)):1===a.button?(C=B.ZOOM,p.set(a.clientX,a.clientY)):2===a.button&&j.userPan&&(C=B.PAN,s.set(a.clientX,a.clientY)),document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",g,!1))}function f(a){if(j.enabled!==!1)if(a.preventDefault(),C===B.ROTATE)n.set(a.clientX,a.clientY),o.subVectors(n,m),j.rotateLeft(2*Math.PI*o.x/l*j.userRotateSpeed),j.rotateUp(2*Math.PI*o.y/l*j.userRotateSpeed),m.copy(n);else if(C===B.ZOOM)q.set(a.clientX,a.clientY),r.subVectors(q,p),r.y>0?j.zoomIn():j.zoomOut(),p.copy(q);else if(C===B.PAN){t.set(a.clientX,a.clientY),u.subVectors(t,s);var b=j.object.position,c=b.clone().sub(j.center);if(j.object instanceof THREE.PerspectiveCamera)var d=j.object.fov*Math.PI/180,e=d*j.object.aspect,f=c.length(),g=j.domElement.clientWidth,h=j.domElement.clientHeight,i=u.x,k=u.y,v=new THREE.Vector3(-(i/g)*f*Math.tan(e/2)*2,k/h*f*Math.tan(d/2)*2,0);else{var v=new THREE.Vector3(-1*u.x,u.y,u.z);v.multiplyScalar(j.userPanSpeed*c.length())}j.move(v),s.copy(t)}}function g(a){j.enabled!==!1&&j.userRotate!==!1&&(document.removeEventListener("mousemove",f,!1),document.removeEventListener("mouseup",g,!1),C=B.NONE)}function h(a){if(j.enabled!==!1&&j.userZoom!==!1){var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail),b>0?j.zoomOut():j.zoomIn()}}function i(a){if(j.enabled!==!1&&j.userPan!==!1)switch(a.keyCode){case j.keys.UP:j.pan(new THREE.Vector3(0,1,0));break;case j.keys.BOTTOM:j.pan(new THREE.Vector3(0,-1,0));break;case j.keys.LEFT:j.pan(new THREE.Vector3(-1,0,0));break;case j.keys.RIGHT:j.pan(new THREE.Vector3(1,0,0))}}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.userPan=!0,this.userPanSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minDistance=0,this.maxDistance=1/0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var j=this,k=1e-6,l=1800,m=new THREE.Vector2,n=new THREE.Vector2,o=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,r=new THREE.Vector2,s=new THREE.Vector2,t=new THREE.Vector2,u=new THREE.Vector2,v=0,w=0,x=1,y=new THREE.Vector3(0,1,0),z=new THREE.Vector3(0,0,1),A=new THREE.Vector3,B={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},C=B.NONE,D={type:"change"};this.move=function(a){var b=this.object.matrix,c=new THREE.Matrix4;c.extractRotation(b);var d=c.elements,e=new THREE.Vector3(d[0],d[1],d[2]),f=new THREE.Vector3(d[4],d[5],d[6]),g=new THREE.Vector3(d[8],d[9],d[10]),h=new THREE.Vector3;h.add(e.clone().multiplyScalar(a.x)).add(f.clone().multiplyScalar(a.y)).add(g.clone().multiplyScalar(a.z)),j.center.add(h),j.object.position.add(h)},this.rotateLeft=function(a){void 0===a&&(a=c()),w-=a},this.rotateRight=function(a){void 0===a&&(a=c()),w+=a},this.rotateUp=function(a){void 0===a&&(a=c()),v-=a},this.rotateDown=function(a){void 0===a&&(a=c()),v+=a},this.zoomIn=function(a){void 0===a&&(a=d()),x/=a},this.zoomOut=function(a){void 0===a&&(a=d()),x*=a},this.pan=function(a){a.transformDirection(this.object.matrix),a.multiplyScalar(j.userPanSpeed),this.object.position.add(a),this.center.add(a)},this.update=function(){var a=this.object.position,b=a.clone().sub(this.center),d=!1,e=this.object.up.angleTo(y);if(e>k){var f,d=!0;f=e<Math.PI-k?this.object.up.clone().cross(y).normalize():z;var g=new THREE.Quaternion;g.setFromAxisAngle(f,e),b.applyQuaternion(g)}var h=Math.atan2(b.x,b.z),i=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y);this.autoRotate&&this.rotateLeft(c()),h+=w,i+=v,i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i)),i=Math.max(k,Math.min(Math.PI-k,i));var j=b.length()*x;j=Math.max(this.minDistance,Math.min(this.maxDistance,j)),b.x=j*Math.sin(i)*Math.sin(h),b.y=j*Math.cos(i),b.z=j*Math.sin(i)*Math.cos(h),d&&b.applyQuaternion(g.inverse()),a.copy(this.center).add(b),this.object.lookAt(this.center),w=0,v=0,x=1,A.distanceTo(this.object.position)>0&&(this.dispatchEvent(D),A.copy(this.object.position))},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",h,!1),this.domElement.addEventListener("DOMMouseScroll",h,!1),this.domElement.addEventListener("keydown",i,!1)},THREE.OrbitControlsLeeper.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls=function(a,b){function c(a){l.enabled!==!1&&(window.removeEventListener("keydown",c),q=p,p===m.NONE&&(a.keyCode!==l.keys[m.ROTATE]||l.noRotate?a.keyCode!==l.keys[m.ZOOM]||l.noZoom?a.keyCode!==l.keys[m.PAN]||l.noPan||(p=m.PAN):p=m.ZOOM:p=m.ROTATE))}function d(a){l.enabled!==!1&&(p=q,window.addEventListener("keydown",c,!1))}function e(a){l.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),p===m.NONE&&(p=a.button),p!==m.ROTATE||l.noRotate?p!==m.ZOOM||l.noZoom?p!==m.PAN||l.noPan||(A.copy(F(a.pageX,a.pageY)),B.copy(A)):(w.copy(F(a.pageX,a.pageY)),x.copy(w)):(t.copy(G(a.pageX,a.pageY)),s.copy(t)),document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",g,!1),l.dispatchEvent(D))}function f(a){l.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),p!==m.ROTATE||l.noRotate?p!==m.ZOOM||l.noZoom?p!==m.PAN||l.noPan||B.copy(F(a.pageX,a.pageY)):x.copy(F(a.pageX,a.pageY)):(s.copy(t),t.copy(G(a.pageX,a.pageY))))}function g(a){l.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),p=m.NONE,document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",g),l.dispatchEvent(E))}function h(a){if(l.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=0;a.wheelDelta?b=a.wheelDelta/40:a.detail&&(b=-a.detail/3),w.y+=.01*b,l.dispatchEvent(D),l.dispatchEvent(E)}}function i(a){if(l.enabled!==!1){switch(a.touches.length){case 1:p=m.TOUCH_ROTATE,t.copy(G(a.touches[0].pageX,a.touches[0].pageY)),s.copy(t);break;case 2:p=m.TOUCH_ZOOM_PAN;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;z=y=Math.sqrt(b*b+c*c);var d=(a.touches[0].pageX+a.touches[1].pageX)/2,e=(a.touches[0].pageY+a.touches[1].pageY)/2;A.copy(F(d,e)),B.copy(A);break;default:p=m.NONE}l.dispatchEvent(D)}}function j(a){if(l.enabled!==!1)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:s.copy(t),t.copy(G(a.touches[0].pageX,a.touches[0].pageY));break;case 2:var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;z=Math.sqrt(b*b+c*c);var d=(a.touches[0].pageX+a.touches[1].pageX)/2,e=(a.touches[0].pageY+a.touches[1].pageY)/2;B.copy(F(d,e));break;default:p=m.NONE}}function k(a){if(l.enabled!==!1){switch(a.touches.length){case 1:s.copy(t),t.copy(G(a.touches[0].pageX,a.touches[0].pageY));break;case 2:y=z=0;var b=(a.touches[0].pageX+a.touches[1].pageX)/2,c=(a.touches[0].pageY+a.touches[1].pageY)/2;B.copy(F(b,c)),A.copy(B)}p=m.NONE,l.dispatchEvent(E)}}var l=this,m={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var n=1e-6,o=new THREE.Vector3,p=m.NONE,q=m.NONE,r=new THREE.Vector3,s=new THREE.Vector2,t=new THREE.Vector2,u=new THREE.Vector3,v=0,w=new THREE.Vector2,x=new THREE.Vector2,y=0,z=0,A=new THREE.Vector2,B=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var C={type:"change"},D={type:"start"},E={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var a=this.domElement.getBoundingClientRect(),b=this.domElement.ownerDocument.documentElement;this.screen.left=a.left+window.pageXOffset-b.clientLeft,this.screen.top=a.top+window.pageYOffset-b.clientTop,this.screen.width=a.width,this.screen.height=a.height}},this.handleEvent=function(a){"function"==typeof this[a.type]&&this[a.type](a)};var F=function(){var a=new THREE.Vector2;return function(b,c){return a.set((b-l.screen.left)/l.screen.width,(c-l.screen.top)/l.screen.height),a}}(),G=function(){var a=new THREE.Vector2;return function(b,c){return a.set((b-.5*l.screen.width-l.screen.left)/(.5*l.screen.width),(l.screen.height+2*(l.screen.top-c))/l.screen.width),a}}();this.rotateCamera=function(){var a,b=new THREE.Vector3,c=new THREE.Quaternion,d=new THREE.Vector3,e=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector3;return function(){g.set(t.x-s.x,t.y-s.y,0),a=g.length(),a?(r.copy(l.object.position).sub(l.target),d.copy(r).normalize(),e.copy(l.object.up).normalize(),f.crossVectors(e,d).normalize(),e.setLength(t.y-s.y),f.setLength(t.x-s.x),g.copy(e.add(f)),b.crossVectors(g,r).normalize(),a*=l.rotateSpeed,c.setFromAxisAngle(b,a),r.applyQuaternion(c),l.object.up.applyQuaternion(c),u.copy(b),v=a):!l.staticMoving&&v&&(v*=Math.sqrt(1-l.dynamicDampingFactor),r.copy(l.object.position).sub(l.target),c.setFromAxisAngle(u,v),r.applyQuaternion(c),l.object.up.applyQuaternion(c)),s.copy(t)}}(),this.zoomCamera=function(){var a;p===m.TOUCH_ZOOM_PAN?(a=y/z,y=z,r.multiplyScalar(a)):(a=1+(x.y-w.y)*l.zoomSpeed,1!==a&&a>0&&(r.multiplyScalar(a),l.staticMoving?w.copy(x):w.y+=(x.y-w.y)*this.dynamicDampingFactor))},this.panCamera=function(){var a=new THREE.Vector2,b=new THREE.Vector3,c=new THREE.Vector3;return function(){a.copy(B).sub(A),a.lengthSq()&&(a.multiplyScalar(r.length()*l.panSpeed),c.copy(r).cross(l.object.up).setLength(a.x),c.add(b.copy(l.object.up).setLength(a.y)),l.object.position.add(c),l.target.add(c),l.staticMoving?A.copy(B):A.add(a.subVectors(B,A).multiplyScalar(l.dynamicDampingFactor)))}}(),this.checkDistances=function(){l.noZoom&&l.noPan||(r.lengthSq()>l.maxDistance*l.maxDistance&&l.object.position.addVectors(l.target,r.setLength(l.maxDistance)),r.lengthSq()<l.minDistance*l.minDistance&&l.object.position.addVectors(l.target,r.setLength(l.minDistance)))},this.update=function(){r.subVectors(l.object.position,l.target),l.noRotate||l.rotateCamera(),l.noZoom||l.zoomCamera(),l.noPan||l.panCamera(),l.object.position.addVectors(l.target,r),l.checkDistances(),l.object.lookAt(l.target),o.distanceToSquared(l.object.position)>n&&(l.dispatchEvent(C),o.copy(l.object.position))},this.reset=function(){p=m.NONE,q=m.NONE,l.target.copy(l.target0),l.object.position.copy(l.position0),l.object.up.copy(l.up0),r.subVectors(l.object.position,l.target),l.object.lookAt(l.target),l.dispatchEvent(C),o.copy(l.object.position)},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",h,!1),this.domElement.addEventListener("DOMMouseScroll",h,!1),this.domElement.addEventListener("touchstart",i,!1),this.domElement.addEventListener("touchend",k,!1),this.domElement.addEventListener("touchmove",j,!1),window.addEventListener("keydown",c,!1),window.addEventListener("keyup",d,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,function(){var a=function(a){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};a.prototype=Object.create(THREE.MeshBasicMaterial.prototype),a.prototype.constructor=a;var b=function(a){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};b.prototype=Object.create(THREE.LineBasicMaterial.prototype),b.prototype.constructor=b,THREE.TransformGizmo=function(){var a=this,b=!1,c=!1;this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var a=new THREE.PlaneBufferGeometry(50,50,2,2),b=new THREE.MeshBasicMaterial({wireframe:!0});b.side=THREE.DoubleSide;var c={XY:new THREE.Mesh(a,b),YZ:new THREE.Mesh(a,b),XZ:new THREE.Mesh(a,b),XYZE:new THREE.Mesh(a,b)};this.activePlane=c.XYZE,c.YZ.rotation.set(0,Math.PI/2,0),c.XZ.rotation.set(-Math.PI/2,0,0);for(var d in c)c[d].name=d,this.planes.add(c[d]),this.planes[d]=c[d],c[d].visible=!1;var e=function(a,b){for(var c in a)for(d=a[c].length;d--;){var e=a[c][d][0],f=a[c][d][1],g=a[c][d][2];e.name=c,f&&e.position.set(f[0],f[1],f[2]),g&&e.rotation.set(g[0],g[1],g[2]),b.add(e)}};e(this.handleGizmos,this.handles),e(this.pickerGizmos,this.pickers),this.traverse(function(a){if(a instanceof THREE.Mesh){a.updateMatrix();var b=a.geometry.clone();b.applyMatrix(a.matrix),a.geometry=b,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1)}})},this.hide=function(){this.traverse(function(a){a.visible=!1})},this.show=function(){this.traverse(function(c){c.visible=!0,c.parent==a.pickers&&(c.visible=b),c.parent==a.planes&&(c.visible=!1)}),this.activePlane.visible=c},this.highlight=function(a){this.traverse(function(b){b.material&&b.material.highlight&&(b.name==a?b.material.highlight(!0):b.material.highlight(!1))})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo,THREE.TransformGizmo.prototype.update=function(a,b){var c=new THREE.Vector3(0,0,0),d=new THREE.Vector3(0,1,0),e=new THREE.Matrix4;this.traverse(function(f){-1!=f.name.search("E")?f.quaternion.setFromRotationMatrix(e.lookAt(b,c,d)):(-1!=f.name.search("X")||-1!=f.name.search("Y")||-1!=f.name.search("Z"))&&f.quaternion.setFromEuler(a)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,d=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(e,new b({
color:16711680}))]],Y:[[new THREE.Mesh(c,new a({color:65280})),[0,.5,0]],[new THREE.Line(f,new b({color:65280}))]],Z:[[new THREE.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(g,new b({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new a({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new a({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new a({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new a({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),new a({color:16777215,opacity:.25}))]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new a({color:16776960,opacity:.25})),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new a({color:65535,opacity:.25})),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new a({color:16711935,opacity:.25})),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(a,b){var c=new THREE.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),"XY"==a&&(this.activePlane=this.planes.XY),"YZ"==a&&(this.activePlane=this.planes.YZ),"XZ"==a&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate,THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var c=function(a,b,c){var d=new THREE.Geometry;c=c?c:1;for(var e=0;64*c>=e;++e)"x"==b&&d.vertices.push(new THREE.Vector3(0,Math.cos(e/32*Math.PI),Math.sin(e/32*Math.PI)).multiplyScalar(a)),"y"==b&&d.vertices.push(new THREE.Vector3(Math.cos(e/32*Math.PI),0,Math.sin(e/32*Math.PI)).multiplyScalar(a)),"z"==b&&d.vertices.push(new THREE.Vector3(Math.sin(e/32*Math.PI),Math.cos(e/32*Math.PI),0).multiplyScalar(a));return d};this.handleGizmos={X:[[new THREE.Line(new c(1,"x",.5),new b({color:16711680}))]],Y:[[new THREE.Line(new c(1,"y",.5),new b({color:65280}))]],Z:[[new THREE.Line(new c(1,"z",.5),new b({color:255}))]],E:[[new THREE.Line(new c(1.25,"z",1),new b({color:13421568}))]],XYZE:[[new THREE.Line(new c(1,"z",1),new b({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:16711680,opacity:.25})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:65280,opacity:.25})),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:255,opacity:.25})),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusGeometry(1.25,.12,2,24),new a({color:16776960,opacity:.25}))]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(a){"E"==a&&(this.activePlane=this.planes.XYZE),"X"==a&&(this.activePlane=this.planes.YZ),"Y"==a&&(this.activePlane=this.planes.XZ),"Z"==a&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(a,b){THREE.TransformGizmo.prototype.update.apply(this,arguments);var c=({handles:this.handles,pickers:this.pickers},new THREE.Matrix4),d=new THREE.Euler(0,0,1),e=new THREE.Quaternion,f=new THREE.Vector3(1,0,0),g=new THREE.Vector3(0,1,0),h=new THREE.Vector3(0,0,1),i=new THREE.Quaternion,j=new THREE.Quaternion,k=new THREE.Quaternion,l=b.clone();d.copy(this.planes.XY.rotation),e.setFromEuler(d),c.makeRotationFromQuaternion(e).getInverse(c),l.applyMatrix4(c),this.traverse(function(a){e.setFromEuler(d),"X"==a.name&&(i.setFromAxisAngle(f,Math.atan2(-l.y,l.z)),e.multiplyQuaternions(e,i),a.quaternion.copy(e)),"Y"==a.name&&(j.setFromAxisAngle(g,Math.atan2(l.x,l.z)),e.multiplyQuaternions(e,j),a.quaternion.copy(e)),"Z"==a.name&&(k.setFromAxisAngle(h,Math.atan2(l.y,l.x)),e.multiplyQuaternions(e,k),a.quaternion.copy(e))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate,THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,d=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(e,new b({color:16711680}))]],Y:[[new THREE.Mesh(c,new a({color:65280})),[0,.5,0]],[new THREE.Line(f,new b({color:65280}))]],Z:[[new THREE.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(g,new b({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new a({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),new a({color:16777215,opacity:.25}))]]},this.setActivePlane=function(a,b){var c=new THREE.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),this.hide(),this.show()},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale,THREE.TransformControls=function(a,b){function c(a){if(void 0!==h.object&&j!==!0){a.preventDefault();var b=a.changedTouches?a.changedTouches[0]:a,c=g(b,h.gizmo[k].pickers.children),d=null;c&&(d=c.object.name),h.axis!==d&&(h.axis=d,h.update(),h.dispatchEvent(l))}}function d(a){if(void 0!==h.object&&j!==!0){a.preventDefault(),j=!0;var b=a.changedTouches?a.changedTouches[0]:a;if(0===b.button||void 0===b.button){var c=g(b,h.gizmo[k].pickers.children);if(c){a.stopPropagation(),i=!0,h.dispatchEvent(m),h.axis=c.object.name,h.update(),x.copy(R).sub(O).normalize(),h.gizmo[k].setActivePlane(h.axis,x);var d=g(b,[h.gizmo[k].activePlane]);J.copy(h.object.position),K.copy(h.object.scale),L.extractRotation(h.object.matrix),Q.extractRotation(h.object.matrixWorld),M.extractRotation(h.object.parent.matrixWorld),N.setFromMatrixScale(y.getInverse(h.object.parent.matrixWorld)),s.copy(d.point)}}}}function e(a){if(void 0!==h.object&&null!==h.axis&&i!==!1){a.preventDefault(),a.stopPropagation();var b=a.changedTouches?a.changedTouches[0]:a,c=g(b,[h.gizmo[k].activePlane]);r.copy(c.point),"translate"==k?(r.sub(s),r.multiply(N),"local"==h.space&&(r.applyMatrix4(y.getInverse(Q)),-1==h.axis.search("X")&&(r.x=0),-1==h.axis.search("Y")&&(r.y=0),-1==h.axis.search("Z")&&(r.z=0),r.applyMatrix4(L),h.object.position.copy(J),h.object.position.add(r)),("world"==h.space||-1!=h.axis.search("XYZ"))&&(-1==h.axis.search("X")&&(r.x=0),-1==h.axis.search("Y")&&(r.y=0),-1==h.axis.search("Z")&&(r.z=0),r.applyMatrix4(y.getInverse(M)),h.object.position.copy(J),h.object.position.add(r)),null!==h.snap&&(-1!=h.axis.search("X")&&(h.object.position.x=Math.round(h.object.position.x/h.snap)*h.snap),-1!=h.axis.search("Y")&&(h.object.position.y=Math.round(h.object.position.y/h.snap)*h.snap),-1!=h.axis.search("Z")&&(h.object.position.z=Math.round(h.object.position.z/h.snap)*h.snap))):"scale"==k?(r.sub(s),r.multiply(N),"local"==h.space&&("XYZ"==h.axis?(v=1+r.y/50,h.object.scale.x=K.x*v,h.object.scale.y=K.y*v,h.object.scale.z=K.z*v):(r.applyMatrix4(y.getInverse(Q)),"X"==h.axis&&(h.object.scale.x=K.x*(1+r.x/50)),"Y"==h.axis&&(h.object.scale.y=K.y*(1+r.y/50)),"Z"==h.axis&&(h.object.scale.z=K.z*(1+r.z/50))))):"rotate"==k&&(r.sub(O),r.multiply(N),z.copy(s).sub(O),z.multiply(N),"E"==h.axis?(r.applyMatrix4(y.getInverse(w)),z.applyMatrix4(y.getInverse(w)),t.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(z.z,z.y),Math.atan2(z.x,z.z),Math.atan2(z.y,z.x)),A.setFromRotationMatrix(y.getInverse(M)),I.setFromAxisAngle(x,t.z-u.z),E.setFromRotationMatrix(Q),A.multiplyQuaternions(A,I),A.multiplyQuaternions(A,E),h.object.quaternion.copy(A)):"XYZE"==h.axis?(I.setFromEuler(r.clone().cross(z).normalize()),A.setFromRotationMatrix(y.getInverse(M)),F.setFromAxisAngle(I,-r.clone().angleTo(z)),E.setFromRotationMatrix(Q),A.multiplyQuaternions(A,F),A.multiplyQuaternions(A,E),h.object.quaternion.copy(A)):"local"==h.space?(r.applyMatrix4(y.getInverse(Q)),z.applyMatrix4(y.getInverse(Q)),t.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(z.z,z.y),Math.atan2(z.x,z.z),Math.atan2(z.y,z.x)),E.setFromRotationMatrix(L),F.setFromAxisAngle(B,t.x-u.x),G.setFromAxisAngle(C,t.y-u.y),H.setFromAxisAngle(D,t.z-u.z),"X"==h.axis&&E.multiplyQuaternions(E,F),"Y"==h.axis&&E.multiplyQuaternions(E,G),"Z"==h.axis&&E.multiplyQuaternions(E,H),h.object.quaternion.copy(E)):"world"==h.space&&(t.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(z.z,z.y),Math.atan2(z.x,z.z),Math.atan2(z.y,z.x)),A.setFromRotationMatrix(y.getInverse(M)),F.setFromAxisAngle(B,t.x-u.x),G.setFromAxisAngle(C,t.y-u.y),H.setFromAxisAngle(D,t.z-u.z),E.setFromRotationMatrix(Q),"X"==h.axis&&A.multiplyQuaternions(A,F),"Y"==h.axis&&A.multiplyQuaternions(A,G),"Z"==h.axis&&A.multiplyQuaternions(A,H),A.multiplyQuaternions(A,E),h.object.quaternion.copy(A))),h.update(),h.dispatchEvent(l),h.dispatchEvent(o)}}function f(a){j=!1,i&&null!==h.axis&&(a.stopPropagation(),n.mode=k,h.dispatchEvent(n)),i=!1,c(a)}function g(c,d){var e=b.getBoundingClientRect(),f=(c.clientX-e.left)/e.width,g=(c.clientY-e.top)/e.height;q.set(2*f-1,-(2*g)+1,.5),q.unproject(a),p.set(R,q.sub(R).normalize());var h=p.intersectObjects(d,!0);return h[0]?h[0]:!1}THREE.Object3D.call(this),b=void 0!==b?b:document,this.gizmo={},this.gizmo.translate=new THREE.TransformGizmoTranslate,this.gizmo.rotate=new THREE.TransformGizmoRotate,this.gizmo.scale=new THREE.TransformGizmoScale,this.add(this.gizmo.translate),this.add(this.gizmo.rotate),this.add(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=void 0,this.snap=null,this.space="world",this.size=1,this.axis=null;var h=this,i=!1,j=!1,k="translate",l={type:"change"},m={type:"mouseDown"},n={type:"mouseUp",mode:k},o={type:"objectChange"},p=new THREE.Raycaster,q=new THREE.Vector3,r=new THREE.Vector3,s=new THREE.Vector3,t=new THREE.Vector3,u=new THREE.Vector3,v=1,w=new THREE.Matrix4,x=new THREE.Vector3,y=new THREE.Matrix4,z=new THREE.Vector3,A=new THREE.Quaternion,B=new THREE.Vector3(1,0,0),C=new THREE.Vector3(0,1,0),D=new THREE.Vector3(0,0,1),E=new THREE.Quaternion,F=new THREE.Quaternion,G=new THREE.Quaternion,H=new THREE.Quaternion,I=new THREE.Quaternion,J=new THREE.Vector3,K=new THREE.Vector3,L=new THREE.Matrix4,M=new THREE.Matrix4,N=new THREE.Vector3,O=new THREE.Vector3,P=new THREE.Euler,Q=new THREE.Matrix4,R=new THREE.Vector3,S=new THREE.Euler;b.addEventListener("mousedown",d,!1),b.addEventListener("touchstart",d,!1),b.addEventListener("mousemove",c,!1),b.addEventListener("touchmove",c,!1),b.addEventListener("mousemove",e,!1),b.addEventListener("touchmove",e,!1),b.addEventListener("mouseup",f,!1),b.addEventListener("mouseout",f,!1),b.addEventListener("touchend",f,!1),b.addEventListener("touchcancel",f,!1),b.addEventListener("touchleave",f,!1),this.attach=function(a){h.object=a,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[k].show(),h.update()},this.detach=function(a){h.object=void 0,this.axis=null,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this.setMode=function(a){k=a?a:k,"scale"==k&&(h.space="local"),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[k].show(),this.update(),h.dispatchEvent(l)},this.setSnap=function(a){h.snap=a},this.setSize=function(a){h.size=a,this.update(),h.dispatchEvent(l)},this.setSpace=function(a){h.space=a,this.update(),h.dispatchEvent(l)},this.update=function(){void 0!==h.object&&(h.object.updateMatrixWorld(),O.setFromMatrixPosition(h.object.matrixWorld),P.setFromRotationMatrix(y.extractRotation(h.object.matrixWorld)),a.updateMatrixWorld(),R.setFromMatrixPosition(a.matrixWorld),S.setFromRotationMatrix(y.extractRotation(a.matrixWorld)),v=O.distanceTo(R)/6*h.size,this.position.copy(O),this.scale.set(v,v,v),x.copy(R).sub(O).normalize(),"local"==h.space?this.gizmo[k].update(P,x):"world"==h.space&&this.gizmo[k].update(new THREE.Euler,x),this.gizmo[k].highlight(h.axis))}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformControls.prototype.constructor=THREE.TransformControls}();